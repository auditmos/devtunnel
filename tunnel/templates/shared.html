<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTunnel - Shared Request</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        header { padding: 20px 0; border-bottom: 1px solid #333; margin-bottom: 20px; }
        h1 { font-size: 1.5rem; color: #00d4ff; }
        .error { background: #7f1d1d; color: #fecaca; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
        .loading { text-align: center; padding: 60px; color: #888; }
        .request-card { background: #252542; border-radius: 8px; padding: 20px; margin-bottom: 16px; }
        .request-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .method { font-weight: 700; padding: 6px 12px; border-radius: 4px; font-size: 0.875rem; }
        .method-get { background: #10b981; color: #fff; }
        .method-post { background: #f59e0b; color: #fff; }
        .method-put { background: #3b82f6; color: #fff; }
        .method-delete { background: #ef4444; color: #fff; }
        .method-patch { background: #8b5cf6; color: #fff; }
        .url { font-family: monospace; color: #ddd; word-break: break-all; flex: 1; }
        .status { font-weight: 600; padding: 4px 8px; border-radius: 4px; }
        .status-2xx { background: #10b981; color: #fff; }
        .status-3xx { background: #f59e0b; color: #fff; }
        .status-4xx { background: #ef4444; color: #fff; }
        .status-5xx { background: #dc2626; color: #fff; }
        .section { margin-bottom: 16px; }
        .section-title { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 8px; }
        .section-content { background: #1a1a2e; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }
        .meta { display: flex; gap: 16px; font-size: 0.875rem; color: #888; margin-bottom: 16px; }
        .expired { text-align: center; padding: 60px; color: #888; }
        .warning { background: #78350f; color: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.875rem; }
        .replay-info { background: #1e3a5f; border: 1px solid #3b82f6; padding: 12px; border-radius: 8px; margin-top: 16px; }
        .replay-info code { background: #0f172a; padding: 8px 12px; display: block; border-radius: 4px; font-size: 0.875rem; word-break: break-all; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DevTunnel - Shared Request</h1>
        </header>
        <div class="warning">
            This request is encrypted end-to-end. The server never sees the decryption key (it's in the URL hash).
        </div>
        <div id="content">
            <div class="loading">Decrypting request...</div>
        </div>
    </div>
    <script>
    (async function() {
        const content = document.getElementById('content');
        const blobId = '{{.ID}}';
        const key = window.location.hash.slice(1);

        if (!key) {
            content.innerHTML = '<div class="error">Missing decryption key in URL. The link may be incomplete.</div>';
            return;
        }

        try {
            const resp = await fetch('/api/blob/' + blobId);
            if (!resp.ok) {
                if (resp.status === 404) {
                    content.innerHTML = '<div class="expired">This shared request has expired or was not found.</div>';
                    return;
                }
                throw new Error('Failed to fetch: ' + resp.status);
            }

            const data = await resp.json();
            const ciphertext = base64ToArrayBuffer(data.ciphertext);

            const keyBytes = base64UrlToArrayBuffer(key);
            const cryptoKey = await crypto.subtle.importKey(
                'raw', keyBytes, { name: 'AES-GCM' }, false, ['decrypt']
            );

            const nonce = ciphertext.slice(0, 12);
            const encrypted = ciphertext.slice(12);

            const plaintext = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: nonce },
                cryptoKey,
                encrypted
            );

            const decoder = new TextDecoder();
            const json = decoder.decode(plaintext);
            const req = JSON.parse(json);

            content.innerHTML = renderRequest(req);
        } catch (err) {
            console.error(err);
            content.innerHTML = '<div class="error">Failed to decrypt: ' + escapeHtml(err.message) + '</div>';
        }
    })();

    function base64ToArrayBuffer(b64) {
        const binary = atob(b64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
    }

    function base64UrlToArrayBuffer(b64url) {
        let b64 = b64url.replace(/-/g, '+').replace(/_/g, '/');
        while (b64.length % 4) b64 += '=';
        return base64ToArrayBuffer(b64);
    }

    function escapeHtml(s) {
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatHeaders(headers) {
        if (!headers || Object.keys(headers).length === 0) return '(none)';
        return Object.entries(headers).map(([k, v]) => escapeHtml(k) + ': ' + escapeHtml(v)).join('\n');
    }

    function statusClass(code) {
        if (code >= 200 && code < 300) return 'status-2xx';
        if (code >= 300 && code < 400) return 'status-3xx';
        if (code >= 400 && code < 500) return 'status-4xx';
        if (code >= 500) return 'status-5xx';
        return '';
    }

    function renderRequest(req) {
        const method = (req.method || 'GET').toLowerCase();
        let html = '<div class="request-card">';
        html += '<div class="request-header">';
        html += '<span class="method method-' + method + '">' + escapeHtml(req.method || 'GET') + '</span>';
        html += '<span class="url">' + escapeHtml(req.url || '/') + '</span>';
        if (req.status_code) {
            html += '<span class="status ' + statusClass(req.status_code) + '">' + req.status_code + '</span>';
        }
        html += '</div>';

        if (req.duration_ms) {
            html += '<div class="meta"><span>Duration: ' + req.duration_ms + 'ms</span></div>';
        }

        html += '<div class="section"><div class="section-title">Request Headers</div>';
        html += '<div class="section-content">' + formatHeaders(req.request_headers) + '</div></div>';

        if (req.request_body) {
            html += '<div class="section"><div class="section-title">Request Body</div>';
            html += '<div class="section-content">' + escapeHtml(req.request_body) + '</div></div>';
        }

        html += '<div class="section"><div class="section-title">Response Headers</div>';
        html += '<div class="section-content">' + formatHeaders(req.response_headers) + '</div></div>';

        if (req.response_body) {
            html += '<div class="section"><div class="section-title">Response Body</div>';
            html += '<div class="section-content">' + escapeHtml(req.response_body) + '</div></div>';
        }

        html += '<div class="replay-info">To replay this request to your localhost:<code>devtunnel replay "' + escapeHtml(window.location.href) + '" --port 3000</code></div>';

        html += '</div>';
        return html;
    }
    </script>
</body>
</html>
